# kosu-monorepo CI configuration file (last updated 05 June 2019)

kind: pipeline
name: tests

steps:
  - name: build-project
    image: gcr.io/kosu-io/node-ci:latest
    pull: always
    environment:
      WEB3_URI: http://kosu-geth:8545
    commands:
      - yarn
      - yarn setup:ci
      - cd packages/kosu-system-contracts
      - yarn deploy:kosu:ci

  - name: npm-tests
    image: gcr.io/kosu-io/node-ci:latest
    pull: always
    environment:
      WEB3_URI: http://kosu-geth:8545
    commands:
      - yarn test:ci
    depends_on:
      - build-project
    when:
      changeset:
        includes:
          [
            .drone.yml,
            packages/kosu-sdk-contracts/**/*.*,
            packages/kosu-system-contracts/**/*.*,
            packages/kosu.js/**/*.*,
            packages/tslint-config/**/*.*,
            packages/tsc-config/**/*.*,
          ]

  - name: solidity-tests
    image: gcr.io/kosu-io/node-ci:latest
    pull: always
    environment:
      WEB3_URI: http://kosu-geth:8545
    commands:
      - yarn contracts:test:ci
    depends_on:
      - build-project
    when:
      changeset:
        includes:
          [
            .drone.yml,
            packages/kosu-sdk-contracts/**/*.*,
            packages/kosu-system-contracts/**/*.*,
            packages/tslint-config/**/*.*,
            packages/tsc-config/**/*.*,
            tsconfig.json,
          ]

  - name: go-kosu
    image: gcr.io/kosu-io/go-kosu-ci:latest
    pull: always
    environment:
      ETHEREUM_TEST_ADDRESS: wss://ethnet.zaidan.io/ws/ropsten
    commands:
      - cd packages/go-kosu
      - make ci
    depends_on:
      - build-project
    when:
      changeset:
        includes:
          [
            .drone.yml,
            packages/go-kosu/**/*.*,
            packages/kosu-sdk-contracts/**/*.*,
            packages/kosu-system-contracts/**/*.*,
          ]

services:
    - name: kosu-geth
      image: gcr.io/kosu-io/kosu-geth:latest
      pull: always
      ports:
          - 8545

trigger:
    event:
        - pull_request
#    changeset:
#      includes:
#        [
#          .drone.yml,
#          package.json,
#          tsconfig.json,
#          packages/go-kosu/**/*.*,
#          packages/kosu-sdk-contracts/**/*.*,
#          packages/kosu-system-contracts/**/*.*,
#          packages/kosu.js/**/*.*,
#          packages/tslint-config/**/*.*,
#          packages/tsc-config/**/*.*,
#        ]

#          Excluding the following due to changes not effecting or having tests
#          Google builds these images on every push.  The commit push with these changes will fail until google build completes
#          packages/dev-images/**/*.*
#          packages/kosu-geth/**/*.*
#          Add these above if tests are added for these packages
#          packages/web-helpers/**/*.*
#          packages/create-portal-helper/**/*.*
#          packages/gov-portal-helper/**/*.*

# UNTESTED
# ---
# kind: pipeline
# name: go-kosu-release
#
# release:
#     image: golang:1.12
#     secrets: [github_token]
#     commands:
#      curl -sL https://git.io/goreleaser | bash
#     when:
#       event: tag
