# Main CD config (build and publish documentation and binaries)

steps:

# =================
# INSTALL AND BUILD
# =================

- name: gcr.io/kosu-io/node-ci:latest
  entrypoint: yarn
  args: ["install"]

- name: gcr.io/kosu-io/node-ci:latest
  entrypoint: yarn
  args: ["build"]

# ==========
# BUILD DOCS
# ==========

- name: gcr.io/kosu-io/node-ci:latest
  entrypoint: yarn
  args: ["docs"]

# ============
# PUBLISH DOCS
# ============

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-docs",
    "gs://kosu-docs"
  ]

# ================
# PUBLISH BINARIES
# ================

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m",
    "cp", 
    "./packages/go-kosu/kosud",
    "gs://kosud/linux_amd64/",
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m",
    "cp", 
    "./packages/go-kosu/kosu-cli",
    "gs://kosu-cli/linux_amd64/",
  ]

# ================
# DEPLOY DOCS SITE
# ================

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-contract-helpers/docs",
    "./packages/kosu-docs/docs/kosu-contract-helpers"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-system-contracts/docs",
    "./packages/kosu-docs/docs/kosu-system-contracts"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-genesis-cli/docs",
    "./packages/kosu-docs/docs/kosu-genesis-cli"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/go-kosu/docs",
    "./packages/kosu-docs/docs/go-kosu"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-node-client/docs",
    "./packages/kosu-docs/docs/kosu-node-client"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-migrations/docs",
    "./packages/kosu-docs/docs/kosu-migrations"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu-deployed-addresses/docs",
    "./packages/kosu-docs/docs/kosu-deployed-addresses"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/kosu.js/docs",
    "./packages/kosu-docs/docs/kosu.js"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/order-server/docs",
    "./packages/kosu-docs/docs/order-server"
  ]

- name: "gcr.io/cloud-builders/gsutil"
  args: [
    "-m", 
    "rsync", 
    "-r", "-c", "-d", 
    "./packages/dev-images/docs",
    "./packages/kosu-docs/docs/dev-images"
  ]

- name: "gcr.io/kosu-io/node-ci:latest"
  entrypoint: "yarn"
  args: [
    "lerna", 
    "run", 
    "--scope",
    "@kosu/documentation", 
    "compile",
  ]

- name: gcr.io/cloud-builders/gsutil
  args: [
    "-m", "rsync", "-r", "-c", "-d",
    "./packages/kosu-docs/docs/.vuepress/dist",
    "gs://docs.kosu.io",
  ]

options: 
 machineType: "N1_HIGHCPU_8"